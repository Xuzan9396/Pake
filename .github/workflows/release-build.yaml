name: Release Build

on:
  push:
    tags:
      - '*-v*.*.*'  # åŒ¹é…æ ¼å¼ï¼šé…ç½®å-vç‰ˆæœ¬å·ï¼Œä¾‹å¦‚ vinted-v1.0.0

env:
  NODE_VERSION: '22'
  PNPM_VERSION: '10.15.0'

jobs:
  parse-tag:
    name: Parse Tag Information
    runs-on: ubuntu-latest
    outputs:
      config_name: ${{ steps.parse.outputs.config_name }}
      version: ${{ steps.parse.outputs.version }}
      config_exists: ${{ steps.parse.outputs.config_exists }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse tag name
        id: parse
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "Tag name: $TAG_NAME"

          # æå–é…ç½®åå’Œç‰ˆæœ¬å·
          # æ ¼å¼ï¼šé…ç½®å-vç‰ˆæœ¬å·
          # ç¤ºä¾‹ï¼švinted-v1.0.0 â†’ é…ç½®å=vinted, ç‰ˆæœ¬=1.0.0

          if [[ ! "$TAG_NAME" =~ ^([a-zA-Z0-9_-]+)-v([0-9]+\.[0-9]+\.[0-9]+.*)$ ]]; then
            echo "Error: Invalid tag format. Expected: <config>-v<version>"
            echo "Example: vinted-v1.0.0"
            exit 1
          fi

          CONFIG_NAME="${BASH_REMATCH[1]}"
          VERSION="${BASH_REMATCH[2]}"

          echo "Config name: $CONFIG_NAME"
          echo "Version: $VERSION"

          # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          CONFIG_FILE="build-configs/${CONFIG_NAME}.json"
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "Error: Config file not found: $CONFIG_FILE"
            echo "Available configs:"
            ls build-configs/*.json || echo "No configs found"
            exit 1
          fi

          echo "config_name=$CONFIG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "config_exists=true" >> $GITHUB_OUTPUT

  read-config:
    name: Read Build Configuration
    needs: parse-tag
    runs-on: ubuntu-latest
    outputs:
      name: ${{ steps.read.outputs.name }}
      url: ${{ steps.read.outputs.url }}
      icon: ${{ steps.read.outputs.icon }}
      width: ${{ steps.read.outputs.width }}
      height: ${{ steps.read.outputs.height }}
      macos_enabled: ${{ steps.read.outputs.macos_enabled }}
      windows_enabled: ${{ steps.read.outputs.windows_enabled }}
      windows_targets: ${{ steps.read.outputs.windows_targets }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read configuration
        id: read
        run: |
          CONFIG_FILE="build-configs/${{ needs.parse-tag.outputs.config_name }}.json"

          echo "Reading config: $CONFIG_FILE"
          cat "$CONFIG_FILE"

          # æå–é…ç½®å€¼
          echo "name=$(jq -r '.name' $CONFIG_FILE)" >> $GITHUB_OUTPUT
          echo "url=$(jq -r '.url' $CONFIG_FILE)" >> $GITHUB_OUTPUT
          echo "icon=$(jq -r '.icon' $CONFIG_FILE)" >> $GITHUB_OUTPUT
          echo "width=$(jq -r '.width' $CONFIG_FILE)" >> $GITHUB_OUTPUT
          echo "height=$(jq -r '.height' $CONFIG_FILE)" >> $GITHUB_OUTPUT

          # å¹³å°é…ç½®
          echo "macos_enabled=$(jq -r '.platforms.macos.enabled' $CONFIG_FILE)" >> $GITHUB_OUTPUT
          echo "windows_enabled=$(jq -r '.platforms.windows.enabled' $CONFIG_FILE)" >> $GITHUB_OUTPUT

          # Windows targets
          WINDOWS_TARGETS=$(jq -c '.platforms.windows.targets' $CONFIG_FILE)
          echo "windows_targets=$WINDOWS_TARGETS" >> $GITHUB_OUTPUT

  build-macos:
    name: Build macOS Universal
    needs: [parse-tag, read-config]
    if: needs.read-config.outputs.macos_enabled == 'true'
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Rust cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            src-tauri/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install dependencies
        run: pnpm install

      - name: Build CLI
        run: pnpm run cli:build

      - name: Build macOS Universal App
        env:
          PAKE_CREATE_APP: 1
        run: |
          echo "Building ${{ needs.read-config.outputs.name }} v${{ needs.parse-tag.outputs.version }}"
          echo "URL: ${{ needs.read-config.outputs.url }}"

          node dist/cli.js ${{ needs.read-config.outputs.url }} \
            --name ${{ needs.read-config.outputs.name }} \
            --icon ${{ needs.read-config.outputs.icon }} \
            --width ${{ needs.read-config.outputs.width }} \
            --height ${{ needs.read-config.outputs.height }} \
            --targets universal

      - name: Package DMG
        run: |
          # Find any .app file (excluding node_modules, git, etc.)
          echo "Searching for .app files..."
          find . -name "*.app" -type d -not -path "*/node_modules/*" -not -path "*/.git/*" -not -path "*/target/*" || true

          APP_PATH=$(find . -name "*.app" -type d -not -path "*/node_modules/*" -not -path "*/.git/*" -not -path "*/target/*" | head -n 1)

          if [ -z "$APP_PATH" ]; then
            echo "Error: No .app file found"
            echo "Searching all directories:"
            find . -type d -name "*.app" || true
            exit 1
          fi

          echo "Found app: $APP_PATH"

          mkdir -p output
          DMG_NAME="${{ needs.read-config.outputs.name }}_v${{ needs.parse-tag.outputs.version }}_macos_universal.dmg"

          mkdir -p dmg_temp
          cp -R "$APP_PATH" dmg_temp/

          hdiutil create -volname "${{ needs.read-config.outputs.name }}" -srcfolder dmg_temp -ov -format UDZO "output/$DMG_NAME"

          rm -rf dmg_temp

          echo "âœ… DMG created: output/$DMG_NAME"
          ls -lh output/

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ needs.parse-tag.outputs.config_name }}-macos-universal
          path: output/*.dmg
          retention-days: 3

  build-windows:
    name: Build Windows ${{ matrix.arch }}
    needs: [parse-tag, read-config]
    if: needs.read-config.outputs.windows_enabled == 'true'
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        arch: ${{ fromJSON(needs.read-config.outputs.windows_targets) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable-msvc
          targets: ${{ matrix.arch == 'x64' && 'x86_64-pc-windows-msvc' || 'aarch64-pc-windows-msvc' }}

      - name: Rust cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            src-tauri/target/
          key: ${{ runner.os }}-${{ matrix.arch }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.arch }}-cargo-

      - name: Install dependencies
        run: pnpm install

      - name: Build CLI
        run: pnpm run cli:build

      - name: Build Windows ${{ matrix.arch }} App
        shell: pwsh
        run: |
          Write-Host "Building ${{ needs.read-config.outputs.name }} v${{ needs.parse-tag.outputs.version }} for Windows ${{ matrix.arch }}"

          node dist/cli.js ${{ needs.read-config.outputs.url }} `
            --name ${{ needs.read-config.outputs.name }} `
            --icon ${{ needs.read-config.outputs.icon }} `
            --width ${{ needs.read-config.outputs.width }} `
            --height ${{ needs.read-config.outputs.height }} `
            --targets ${{ matrix.arch }}

      - name: Find and rename MSI
        shell: pwsh
        run: |
          # Search for any .msi file in project root
          Write-Host "Searching for MSI files in project root..."
          $msiFiles = Get-ChildItem -Path . -Filter "*.msi" -File -ErrorAction SilentlyContinue

          if ($msiFiles) {
            Write-Host "Found MSI files in root:"
            $msiFiles | ForEach-Object { Write-Host "  - $($_.Name)" }
            $msiPath = $msiFiles[0].FullName
          } else {
            Write-Host "No MSI in root, searching entire project..."
            $msiFiles = Get-ChildItem -Path . -Recurse -Filter "*.msi" -File -ErrorAction SilentlyContinue | Where-Object {
              $_.FullName -notlike "*\node_modules\*" -and
              $_.FullName -notlike "*\.git\*"
            }

            if ($msiFiles) {
              Write-Host "Found MSI files:"
              $msiFiles | ForEach-Object { Write-Host "  - $($_.FullName)" }
              $msiPath = $msiFiles[0].FullName
            } else {
              Write-Error "No MSI file found anywhere in the project"
              exit 1
            }
          }

          Write-Host "Using MSI: $msiPath"

          New-Item -Path "output" -ItemType Directory -Force

          $newName = "${{ needs.read-config.outputs.name }}_v${{ needs.parse-tag.outputs.version }}_windows_${{ matrix.arch }}.msi"
          Copy-Item -Path $msiPath -Destination "output\$newName"

          Write-Host "âœ… MSI created: output\$newName"
          Get-ChildItem -Path "output"

      - name: Upload Windows ${{ matrix.arch }} artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ needs.parse-tag.outputs.config_name }}-windows-${{ matrix.arch }}
          path: output/*.msi
          retention-days: 3

  create-release:
    name: Create Release
    needs: [parse-tag, read-config, build-macos, build-windows]
    if: always() && needs.parse-tag.outputs.config_exists == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -R artifacts/

      - name: Generate release body
        id: release-body
        run: |
          cat > release_body.md << EOF
          ## ${{ needs.read-config.outputs.name }} v${{ needs.parse-tag.outputs.version }}

          ### ğŸ“¦ Downloads

          EOF

          # åˆ—å‡ºæ‰€æœ‰äº§ç‰©
          echo "#### macOS" >> release_body.md
          if [ -d "artifacts/${{ needs.parse-tag.outputs.config_name }}-macos-universal" ]; then
            ls artifacts/${{ needs.parse-tag.outputs.config_name }}-macos-universal/ | while read file; do
              echo "- \`$file\`" >> release_body.md
            done
          else
            echo "- â­ï¸ Skipped (disabled in config)" >> release_body.md
          fi
          echo "" >> release_body.md

          echo "#### Windows" >> release_body.md
          if [ -d "artifacts/${{ needs.parse-tag.outputs.config_name }}-windows-x64" ]; then
            ls artifacts/${{ needs.parse-tag.outputs.config_name }}-windows-x64/ | while read file; do
              echo "- \`$file\`" >> release_body.md
            done
          fi
          if [ -d "artifacts/${{ needs.parse-tag.outputs.config_name }}-windows-arm64" ]; then
            ls artifacts/${{ needs.parse-tag.outputs.config_name }}-windows-arm64/ | while read file; do
              echo "- \`$file\`" >> release_body.md
            done
          fi
          if [ ! -d "artifacts/${{ needs.parse-tag.outputs.config_name }}-windows-x64" ] && [ ! -d "artifacts/${{ needs.parse-tag.outputs.config_name }}-windows-arm64" ]; then
            echo "- â­ï¸ Skipped (disabled in config)" >> release_body.md
          fi
          echo "" >> release_body.md

          cat >> release_body.md << EOF

          ### ğŸ“‹ Information

          - **URL**: ${{ needs.read-config.outputs.url }}
          - **Window Size**: ${{ needs.read-config.outputs.width }} x ${{ needs.read-config.outputs.height }}
          - **Config**: \`${{ needs.parse-tag.outputs.config_name }}\`

          ### ğŸ“– Installation

          **macOS**: Download the DMG file, open it, and drag the app to Applications folder.

          **Windows**: Download the MSI file for your architecture and run it.

          ---

          ğŸ¤– Built with [Pake](https://github.com/tw93/Pake)
          EOF

          cat release_body.md

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          name: ${{ needs.read-config.outputs.name }} v${{ needs.parse-tag.outputs.version }}
          tag: ${{ github.ref_name }}
          bodyFile: release_body.md
          artifacts: "artifacts/**/*"
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: false
          prerelease: false
          allowUpdates: true
